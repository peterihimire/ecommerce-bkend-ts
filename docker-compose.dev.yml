version: "3.8"

services:
  redis:
    image: redis
    networks:
      appnet:
        ipv4_address: 192.168.0.2
    restart: always
    env_file:
      - .env

  db:
    image: postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./data/pgdata:/var/lib/postgresql/data
    networks:
      appnet:
        ipv4_address: 192.168.0.3
    ports:
      - 5439:5432
    restart: always
    env_file:
      - .env

  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
    volumes:
      - ./data/pgadmindata:/var/lib/pgadmin/data
    networks:
      appnet:
        ipv4_address: 192.168.0.4
    ports:
      - 4051:80
      - 4050:443
    restart: always
    env_file:
      - .env

  api:
    build:
      context: .
      target: development
    image: peterihimire/ecommerce-bkend-ts
    platform: linux/amd64
    depends_on:
      - db
      - redis
      - pgadmin
    networks:
      appnet:
        ipv4_address: 192.168.0.5
    environment:
      - NODE_ENV=development
      - DB_HOST=db
      - REDIS_HOST=redis
      - PORT=${PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_PORT=${REDIS_PORT}
      - SESSION_SECRET=${SESSION_SECRET}
      - ADMIN_SESSION_SECRET=${ADMIN_SESSION_SECRET}
      - CART_SESSION_SECRET=${CART_SESSION_SECRET}
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - PAYSTACK_PUBLIC_KEY=${PAYSTACK_PUBLIC_KEY}
      - PAYSTACK_SECRET_KEY=${PAYSTACK_SECRET_KEY}
      - STRIPE_PUBLISH_KEY=${STRIPE_PUBLISH_KEY}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_ENDPOINT_SECRET=${STRIPE_ENDPOINT_SECRET}
      - BREVO_API_KEY=${BREVO_API_KEY}
      - SMS_KEY=${SMS_KEY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    volumes:
      - ./:/app
      - /app/node_modules
    ports:
      - 4040:4040
    restart: always
    env_file:
      - .env
    command: npm run dev

networks:
  appnet:
    driver: bridge
    ipam:
      config:
        - subnet: "192.168.0.0/24"
          gateway: 192.168.0.1
# version: "3.8"

# services:
#   api:
#     build:
#       context: .
#       target: development
#     volumes:
#       - ./:/app
#       - /app/node_modules
#     ports:
#       - 4040:4040
#     command: npm run dev

# version: "3.8"

# services:
#   redis:
#     image: redis
#     networks:
#       - appnet
#     restart: always
#     env_file:
#       - .env

#   db:
#     image: postgres
#     environment:
#       - POSTGRES_USER=${POSTGRES_USER}
#       - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
#       - POSTGRES_DB=${POSTGRES_DB}
#     volumes:
#       - ./data/pgdata:/var/lib/postgresql/data
#     networks:
#       - appnet
#     ports:
#       - 5439:5432
#     restart: always
#     env_file:
#       - .env

#   pgadmin:
#     image: dpage/pgadmin4
#     environment:
#       - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
#       - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
#     volumes:
#       - ./data/pgadmindata:/var/lib/pgadmin/data
#     networks:
#       - appnet
#     ports:
#       - 4051:80
#       - 4050:443
#     restart: always
#     env_file:
#       - .env

#   api:
#     build:
#       context: .
#       target: development
#     image: peterihimire/ecommerce-bkend-ts
#     platform: linux/amd64
#     depends_on:
#       - db
#       - redis
#       - pgadmin
#     networks:
#       - appnet
#     environment:
#       - NODE_ENV=development
#       - DB_HOST=db
#       - REDIS_HOST=redis
#       - PORT=${PORT}
#       - DB_NAME=${DB_NAME}
#       - DB_USER=${DB_USER}
#       - DB_PASSWORD=${DB_PASSWORD}
#       - REDIS_PORT=${REDIS_PORT}
#       - SESSION_SECRET=${SESSION_SECRET}
#       - ADMIN_SESSION_SECRET=${ADMIN_SESSION_SECRET}
#       - CART_SESSION_SECRET=${CART_SESSION_SECRET}
#       - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
#       - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
#       - POSTGRES_USER=${POSTGRES_USER}
#       - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
#       - POSTGRES_DB=${POSTGRES_DB}
#       - PAYSTACK_PUBLIC_KEY=${PAYSTACK_PUBLIC_KEY}
#       - PAYSTACK_SECRET_KEY=${PAYSTACK_SECRET_KEY}
#       - STRIPE_PUBLISH_KEY=${STRIPE_PUBLISH_KEY}
#       - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
#       - STRIPE_ENDPOINT_SECRET=${STRIPE_ENDPOINT_SECRET}
#       - BREVO_API_KEY=${BREVO_API_KEY}
#       - SMS_KEY=${SMS_KEY}
#       - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
#       - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
#     volumes:
#       - ./:/app
#       - /app/node_modules
#     ports:
#       - 4040:4040
#     restart: always
#     env_file:
#       - .env
#     command: npm run dev

#   env-test:
#     image: alpine
#     command: env
#     env_file:
#       - .env
#     networks:
#       - appnet

# networks:
#   appnet:

# version: "3.8"

# services:
#   nginx:
#     image: nginx:stable-alpine
#     ports:
#       - 4040:80
#     volumes:
#       - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
#   redis:
#     image: redis
#     networks:
#       - appnet
#   db:
#     image: postgres
#     environment:
#       POSTGRES_USER: postgres
#       POSTGRES_PASSWORD: testing123
#       POSTGRES_DB: ecommerce_dev
#     volumes:
#       - ./pgdata:/var/lib/postgresql/data
#     networks:
#       - appnet
#     ports:
#       - 5433:5432
#   pgadmin:
#     image: dpage/pgadmin4
#     environment:
#       PGADMIN_DEFAULT_EMAIL: root@root.com
#       PGADMIN_DEFAULT_PASSWORD: testing123
#     volumes:
#       - ./pgadmindata:/var/lib/pgadmin/data
#     networks:
#       - appnet
#     ports:
#       - 4050:80
#   api:
#     build:
#       context: .
#       target: development
#     volumes:
#       - ./:/app
#       - /app/node_modules
#     # ports:
#     #   - 4040:4040
#     env_file: .env
#     depends_on:
#       - db
#       - redis
#       - pgadmin
#     networks:
#       - appnet
#     environment:
#       DB_HOST: db
#       REDIS_HOST: redis
#     command: npm run dev
# networks:
#   appnet:
